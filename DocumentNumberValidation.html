<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Android - Passo a Passo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.0/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jwt-decode/3.1.2/jwt-decode.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .debug-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }
        .step.success {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        .step.error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        .step.warning {
            border-left-color: #ffc107;
            background-color: #fff3cd;
        }
        .code {
            background-color: #f1f1f1;
            padding: 5px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border: 2px solid #007bff;
            border-radius: 8px;
            background-color: #e3f2fd;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>üîç Debug Android - Autentica√ß√£o Passo a Passo</h1>
        
        <div class="debug-container">
            <h2>Simulador de Interface Android</h2>
            <button onclick="simulateAndroidInterface()">ü§ñ Simular window.Personal (Android)</button>
            <button onclick="clearDebug()">üßπ Limpar Debug</button>
        </div>

        <div id="debugSteps"></div>
        
        <div id="content" class="result">
            <strong>Resultado Final:</strong> Aguardando execu√ß√£o...
        </div>
    </div>

    <script>
        let debugSteps = [];

        function addDebugStep(message, type = 'info', data = null) {
            const timestamp = new Date().toLocaleTimeString();
            debugSteps.push({
                timestamp,
                message,
                type,
                data
            });
            updateDebugDisplay();
        }

        function updateDebugDisplay() {
            const container = document.getElementById('debugSteps');
            container.innerHTML = debugSteps.map((step, index) => `
                <div class="step ${step.type}">
                    <strong>Passo ${index + 1} [${step.timestamp}]:</strong> ${step.message}
                    ${step.data ? `<div class="code">${JSON.stringify(step.data, null, 2)}</div>` : ''}
                </div>
            `).join('');
        }

        function clearDebug() {
            debugSteps = [];
            updateDebugDisplay();
            document.getElementById('content').innerHTML = '<strong>Resultado Final:</strong> Aguardando execu√ß√£o...';
        }

        function simulateAndroidInterface() {
            // Simula a interface do Android
            const mockToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwiZG9jdW1lbnROdW1iZXIiOiIxMjM0NTY3ODkiLCJpYXQiOjE1MTYyMzkwMjJ9.mockSignature';
            
            window.Personal = {
                getToken: function(param) {
                    addDebugStep(`ü§ñ Android: Chamando window.Personal.getToken('${param}')`, 'info');
                    return mockToken;
                },
                getLanguage: function() {
                    addDebugStep('ü§ñ Android: Chamando window.Personal.getLanguage()', 'info');
                    return 'pt-BR';
                },
                getClientKey: function() {
                    addDebugStep('ü§ñ Android: Chamando window.Personal.getClientKey()', 'info');
                    return 'android-client-key-123';
                }
            };

            // Inicia o processo de debug
            authCommitmentWithDebug();
        }

        function validateToken(token) {
            addDebugStep('üîê Iniciando valida√ß√£o do token...', 'info');
            addDebugStep(`Token a ser validado: ${token.substring(0, 20)}...`, 'info');
            
            // Simula uma valida√ß√£o bem-sucedida para fins de debug
            return new Promise((resolve) => {
                setTimeout(() => {
                    addDebugStep('‚úÖ Token validado com sucesso (simulado)', 'success');
                    resolve(true);
                }, 1000);
            });
        }

        function decodeToken(token) {
            addDebugStep('üîì Iniciando decodifica√ß√£o do token...', 'info');
            
            try {
                // Para fins de debug, vamos simular a decodifica√ß√£o
                const mockDecoded = {
                    sub: "1234567890",
                    documentNumber: "123456789",
                    iat: 1516239022
                };
                
                addDebugStep('‚úÖ Token decodificado com sucesso', 'success', mockDecoded);
                addDebugStep(`üìÑ Document Number extra√≠do: ${mockDecoded.documentNumber}`, 'success');
                
                return mockDecoded.documentNumber;
            } catch (error) {
                addDebugStep(`‚ùå Erro ao decodificar token: ${error.message}`, 'error');
                return null;
            }
        }

        async function authCommitmentWithDebug() {
            addDebugStep('üöÄ IN√çCIO: Executando authCommitment()', 'info');
            
            let token = '';
            let language = '';
            let clientKey = '';

            addDebugStep('üì± Verificando se estamos no ambiente Android...', 'info');

            // TRECHO ESPEC√çFICO DO ANDROID COM DEBUG DETALHADO
            if (window.Personal) {
                addDebugStep('‚úÖ ANDROID DETECTADO: window.Personal est√° dispon√≠vel', 'success');
                
                addDebugStep('üéØ Passo 1: Obtendo token via window.Personal.getToken()', 'info');
                token = window.Personal.getToken('anyParam');
                addDebugStep(`‚úÖ Token obtido: ${token ? token.substring(0, 30) + '...' : 'VAZIO'}`, token ? 'success' : 'error');
                
                if (token) {
                    addDebugStep('üíæ Passo 2: Salvando token no localStorage', 'info');
                    // Simulamos o localStorage para fins de debug
                    addDebugStep('‚úÖ Token salvo no localStorage com chave "auth"', 'success');
                    
                    addDebugStep('üåê Passo 3: Obtendo idioma via window.Personal.getLanguage()', 'info');
                    language = window.Personal.getLanguage();
                    addDebugStep(`‚úÖ Idioma obtido: ${language}`, 'success');
                    
                    addDebugStep('üîë Passo 4: Obtendo clientKey via window.Personal.getClientKey()', 'info');
                    clientKey = window.Personal.getClientKey();
                    addDebugStep(`‚úÖ ClientKey obtido: ${clientKey}`, 'success');
                    
                    // Continuando com a valida√ß√£o
                    addDebugStep('üîê Passo 5: Iniciando valida√ß√£o do token...', 'info');
                    const isValid = await validateToken(token);
                    
                    if (isValid) {
                        addDebugStep('‚úÖ Token v√°lido! Prosseguindo para decodifica√ß√£o...', 'success');
                        
                        addDebugStep('üîì Passo 6: Decodificando token para extrair documentNumber...', 'info');
                        const documentNumber = decodeToken(token);
                        
                        if (documentNumber) {
                            addDebugStep(`üéâ SUCESSO TOTAL! Document Number: ${documentNumber}`, 'success');
                            document.getElementById('content').innerHTML = `
                                <strong>‚úÖ SUCESSO - Android:</strong><br>
                                Document Number: ${documentNumber}<br>
                                Language: ${language}<br>
                                Client Key: ${clientKey}
                            `;
                        } else {
                            addDebugStep('‚ùå ERRO: N√£o foi poss√≠vel extrair documentNumber do token', 'error');
                            document.getElementById('content').innerHTML = '<strong>‚ùå ERRO:</strong> N√£o podemos exibir as informa√ß√µes - documento n√£o informado';
                        }
                    } else {
                        addDebugStep('‚ùå ERRO: Token inv√°lido', 'error');
                        document.getElementById('content').innerHTML = '<strong>‚ùå ERRO:</strong> Token inv√°lido';
                    }
                } else {
                    addDebugStep('‚ùå ERRO: Token n√£o foi obtido do Android', 'error');
                    document.getElementById('content').innerHTML = '<strong>‚ùå ERRO:</strong> Token n√£o obtido';
                }
            } else {
                addDebugStep('‚ö†Ô∏è window.Personal n√£o encontrado - n√£o √© ambiente Android', 'warning');
                document.getElementById('content').innerHTML = '<strong>‚ö†Ô∏è AVISO:</strong> N√£o √© ambiente Android';
            }

            addDebugStep('üèÅ FIM: authCommitment() executado', 'info');
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            addDebugStep('üìÑ DOM carregado, pronto para debug', 'info');
        });
    </script>
</body>
</html>