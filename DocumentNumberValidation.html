<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Android WebView</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.0/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jwt-decode/3.1.2/jwt-decode.min.js"></script>
</head>
<body>
    <div id="content">
        <p>Carregando...</p>
    </div>

    <script>
        function validateToken(token) {
            console.log('üîê DEBUG: Iniciando validateToken com token:', token);
            
            return axios.get('https://prod.globalhealth.mv/uaa/validate/token', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
                .then(response => {
                    console.log('‚úÖ DEBUG: Token validado com sucesso:', response);
                    return true;
                })
                .catch(error => {
                    console.error('‚ùå DEBUG: Erro na valida√ß√£o do token:', error.response ? error.response.data : error.message);
                    return false;
                });
        }

        function decodeToken(token) {
            console.log('üîì DEBUG: Iniciando decodeToken com token:', token);
            
            try {
                const decoded = jwt_decode(token);
                console.log('‚úÖ DEBUG: Token decodificado:', decoded);
                console.log('üìÑ DEBUG: documentNumber extra√≠do:', decoded.documentNumber);
                return decoded.documentNumber;
            } catch (error) {
                console.error('‚ùå DEBUG: Erro ao decodificar o token:', error.message);
                return null;
            }
        }

        async function authCommitment() {
            console.log('üöÄ DEBUG: Iniciando authCommitment()');
            
            let token = '';
            let language = '';
            let clientKey = '';

            // DEBUG: Verificar se window.Personal existe
            console.log('üîç DEBUG: Verificando window.Personal:', window.Personal);
            
            if (window.Personal) {
                console.log('‚úÖ DEBUG: window.Personal existe:', window.Personal);
                alert('DEBUG: window.Personal encontrado!');
                
                console.log('üì± DEBUG: Entrando no bloco Android');
                alert('DEBUG: Entrou no bloco Android (window.Personal)');
                
                console.log('üéØ DEBUG: Chamando window.Personal.getToken()');
                token = window.Personal.getToken('anyParam');
                console.log('üîë DEBUG: Token obtido:', token);
                alert('DEBUG: Token obtido: ' + (token ? token.substring(0, 50) + '...' : 'VAZIO'));
                
                if (token) {
                    console.log('üíæ DEBUG: Salvando token no localStorage');
                    localStorage.setItem("auth", token);
                    alert('DEBUG: Token salvo no localStorage');
                    
                    console.log('üåê DEBUG: Obtendo language');
                    language = window.Personal.getLanguage();
                    console.log('üåç DEBUG: Language obtido:', language);
                    alert('DEBUG: Language: ' + language);
                    
                    console.log('üîë DEBUG: Obtendo clientKey');
                    clientKey = window.Personal.getClientKey();
                    console.log('üóùÔ∏è DEBUG: ClientKey obtido:', clientKey);
                    alert('DEBUG: ClientKey: ' + clientKey);
                } else {
                    console.log('‚ùå DEBUG: Token est√° vazio');
                    alert('DEBUG: ERRO - Token vazio!');
                }
            } else {
                console.log('‚ùå DEBUG: window.Personal N√ÉO existe');
                alert('DEBUG: window.Personal N√ÉO encontrado!');
            }

            // iOS
            window.setConfig = async function (tokenParam, languageParam, clientKeyParam) {
                console.log('üçé DEBUG: setConfig chamado (iOS)');
                
                if (tokenParam && languageParam) {
                    token = tokenParam;
                    localStorage.setItem("auth", token);
                    language = languageParam;
                    clientKey = clientKeyParam;
                    const isValid = await validateToken(token);
                    if (isValid) {
                        const documentNumber = decodeToken(token);
                        if (documentNumber) {
                            document.getElementById('content').innerHTML = `<p>Document Number: ${documentNumber}</p>`;
                        } else {
                            document.getElementById('content').innerHTML = '<p>N√£o podemos exibir as informa√ß√µes</p>';
                        }
                    } else {
                        document.getElementById('content').innerHTML = '<p>N√£o podemos exibir as informa√ß√µes</p>';
                    }
                }
            };

            // EXEMPLO IMPLEMENTA√á√ÉO PERSONAL-WEB
            window.addEventListener('message', async (event) => {
                console.log('üí¨ DEBUG: Mensagem recebida (Personal-Web):', event.data);

                const { token, language, clientKey } = event.data;

                if (token && language && clientKey) {
                    localStorage.setItem("auth", token);
                    const isValid = await validateToken(token);
                    if (isValid) {
                        const documentNumber = decodeToken(token);
                        if (documentNumber) {
                            document.getElementById('content').innerHTML = `<p>Document Number: ${documentNumber}</p>`;
                        } else {
                            document.getElementById('content').innerHTML = '<p>N√£o podemos exibir as informa√ß√µes</p>';
                        }
                    } else {
                        document.getElementById('content').innerHTML = '<p>N√£o podemos exibir as informa√ß√µes</p>';
                    }
                } else {
                    document.getElementById('content').innerHTML = '<p>N√£o podemos exibir as informa√ß√µes, dados ausentes ou inv√°lidos.</p>';
                }
            });

            // Caso o token j√° esteja presente na Web
            console.log('üåê DEBUG: Verificando se j√° existe token:', token);
            
            if (token) {
                console.log('‚úÖ DEBUG: Token encontrado, validando...');
                alert('DEBUG: Iniciando valida√ß√£o do token');
                
                const isValid = await validateToken(token);
                console.log('üîê DEBUG: Resultado da valida√ß√£o:', isValid);
                alert('DEBUG: Token v√°lido: ' + isValid);
                
                if (isValid) {
                    console.log('‚úÖ DEBUG: Token v√°lido, decodificando...');
                    const documentNumber = decodeToken(token);
                    console.log('üìÑ DEBUG: DocumentNumber final:', documentNumber);
                    alert('DEBUG: DocumentNumber: ' + documentNumber);
                    
                    if (documentNumber) {
                        document.getElementById('content').innerHTML = `<p>Document Number: ${documentNumber}</p>`;
                    } else {
                        document.getElementById('content').innerHTML = '<p>N√£o podemos exibir as informa√ß√µes. Documento n√£o foi informado</p>';
                    }
                } else {
                    document.getElementById('content').innerHTML = '<p>N√£o podemos exibir as informa√ß√µes, pois o token recebido n√£o √© v√°lido</p>';
                }
            } else {
                console.log('‚ùå DEBUG: Nenhum token encontrado');
                alert('DEBUG: Nenhum token foi encontrado');
                document.getElementById('content').innerHTML = '<p>N√£o podemos exibir as informa√ß√µes, pois n√£o foi informado nenhum token</p>';
            }
            
            console.log('üèÅ DEBUG: authCommitment() finalizado');
        }

        document.addEventListener('DOMContentLoaded', authCommitment);
    </script>
</body>
</html>
